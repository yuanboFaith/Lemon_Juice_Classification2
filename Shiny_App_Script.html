<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Shiny_App_Script.utf8</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="ICEplots.html">ICE plots</a>
</li>
<li>
  <a href="LemonMLscript.html">Machine Learning Script</a>
</li>
<li>
  <a href="Shiny_App_Script.html">Shiny App Script</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<p><br> <b>Visit our <a href="https://boyuan.shinyapps.io/LemonClassification/">Shiny App</a> for interactive prediction of lemon juices identity. </b></p>
<pre class="r"><code># Shiny packages
library(shiny)
library(DT)
library(rdrop2)

# general function
library(readxl)
library(rebus)
library(stringr)
library(gridExtra)
library(cowplot)
library(RColorBrewer)

# machine learning packages
library(glmnet)
library(MASS)
library(e1071)
library(rsample)
library(randomForest)

# finally load tidyverse avoiding key functions from being masked
library(tidyverse)




# Import data from Dropbox --------
drop_auth()
token = drop_auth()
saveRDS(token, file = &quot;token.rds&quot;)

d = drop_read_csv(file = &quot;Shiny lemon final data_CLEANED UP.csv&quot;) 

# check extreme values of original data
# d[, -c(1:4)]  %&gt;% apply(2, min)
# d[, -c(1:4)]  %&gt;% apply(2, max)


# Global color set
Pastel1 = brewer.pal(9, &quot;Pastel1&quot;)
color.types = Pastel1[1:3]
names(color.types) = c(&quot;adulterated&quot;, &quot;authentic&quot;, &quot;commercial&quot;)



# normalize training set (entire dataset)
d.contentOnly = d %&gt;% select(-c(code, Sample, type, character))
d.scaled = cbind(type = d$type, d.contentOnly %&gt;% scale() %&gt;% as_tibble()) %&gt;% as_tibble()
vector.mean = apply(d.contentOnly, 2, mean)
vector.std =  apply(d.contentOnly, 2, sd)




# MODELS -----
# Linear Discriminant Analysis (LDA) 
mdl.lda = lda(data = d.scaled, type ~., prior = rep(1/3, 3))

fitted.lda = predict(mdl.lda, newdata = newSample.scaled)
fitted.label.lda = fitted.lda$class
fitted.prob.lda = fitted.lda$posterior



# Support vector machine (SV) 
# tune.svm = tune.svm(x = d.scaled[, -1], y = d.scaled$type, 
#                     kernel = &quot;radial&quot;, type = &quot;C-classification&quot;,
#                     gamma = 10^(seq(-4, 4, by = .5)), cost = 10^(seq(-4, 4, by = .5)))
# bestGamma = tune.svm$best.parameters$gamma
# bestCost = tune.svm$best.parameters$cost

mdl.svm = svm(data = d.scaled, type ~., 
              gamma = .1, cost = 10, # best parameter tuned as above
              kernel = &quot;radial&quot;, type = &quot;C-classification&quot;)



# Random forest (RF) 
# cv.rf = d.scaled %&gt;% vfold_cv(v = 6, strata = &quot;type&quot;) %&gt;%
#   mutate(train = map(.x = splits, .f = ~training(.x)),
#          validate = map(.x = splits, .f = ~testing(.x))) %&gt;% 
#   select(-splits) %&gt;%
#   crossing(ntree = seq(400, 1000, by = 200), mtry = 2:6) %&gt;%
#   mutate(param = map2(.x = ntree, .y = mtry, .f = ~list(.x, .y))) %&gt;% # ntree 1st; mtry 2nd
#   mutate(model = map2(.x = train, .y = param, 
#                       .f = ~randomForest(x = .x[, -1], y = .x[[1]], ntree = .y[[1]], mtry = .y[[2]]  ))) %&gt;%
#   mutate(fitted.validate = map2(.x = model, .y = validate, 
#                                 .f = ~ predict(.x, .y, type = &quot;response&quot;)  )) %&gt;%
#   mutate(actual.validate = map(.x = validate, .f = ~ .x[[1]])) %&gt;%
#   mutate(accuracy = map2_dbl(.x = fitted.validate, .y = actual.validate, 
#                          .f = ~ sum(.x == .y) / length(.x) ))
#   
# cv.summary = cv.rf %&gt;% group_by(ntree, mtry) %&gt;%
#   summarise(accuracy.mean = mean(accuracy),
#             accuracy.sd = sd(accuracy)) %&gt;%
#   arrange(desc(accuracy.mean) ) 

# 0.86 ~ 0.88, accuracy is much close, actually not significantly different

mdl.rf = randomForest(x = d.scaled[, -1], y = d.scaled$type, ntree = 400, mtry = 2)



# Naive Bayes
# Set up model on entire training set
mdl.nb = naiveBayes(x = d.scaled[, -1], 
                    y = d.scaled$type %&gt;% as.factor(), # y has to be factor 
                    prior = c(1/3, 1/3, 1/3)) 



# regularized logistic (softmax) regression
# cross validation to check model performance. 
# mdl.lg.cv = cv.glmnet(x = d.scaled[, -1] %&gt;% as.matrix(), 
#                       y = d.scaled$type, family = &quot;multinomial&quot;, alpha = 1)
# plot(mdl.lg.cv)

# mdl.lg.cv$lambda.1se being 0.07898059; could change slightly due to randomization of cross-validation folds
mdl.lr = glmnet(x = d.scaled[, -1] %&gt;% as.matrix(), y = d.scaled$type,
                lambda = 0.07898059,  family = &quot;multinomial&quot;, alpha = 1)





# Define UI -----
ui &lt;- fluidPage(
    
    br(),
    # Application title
    strong(&quot;Lemon Juice Classification with Machine Learning&quot;, style = &quot;font-size:200%;&quot;),
    
    br(),
    
    
    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            
            strong(see [construction script](https://boyuan.shinyapps.io/CatnipQC/) ),
                
                # strong(&quot;Organic acids&quot;, style = &quot;color:orange; font-size: 120%;&quot;),
                fluidRow(column(4, sliderInput(&quot;Citric.acid&quot;, &quot;Citric acid&quot;, min = 0, max = 200, value = 12.97)),
                         column(4, sliderInput(&quot;Malic.acid&quot;, &quot;Malic acid&quot;, min = 0, max = 60, value = 6.52)),
                         column(4, sliderInput(&quot;Ascorbic.acid&quot;, &quot;Ascorbic acid&quot;, min = 0, max = 15, value = 0.07))),
            
            
            
            # strong(&quot;Saccharides&quot;, style = &quot;color:orange; font-size: 120%;&quot;),
            fluidRow(column(4, sliderInput(&quot;Sucrose&quot;, &quot;Sucrose&quot;, min = 0, max = 400, value = 12.7)),
                     column(4, sliderInput(&quot;glucose.fructose&quot;, &quot;Glu/Fructose&quot;, min = 0, max = 600, value = 35.02))),
            
            
            
            # strong(&quot;Phenolic acids&quot;, style = &quot;color:orange; font-size: 120%;&quot;),
            
            fluidRow(column(4, sliderInput(&quot;X3.4.di.HBA&quot;, &quot;3, 4-diHBA&quot;, min = 0, max = 800, value = 92.14)),
                     column(4, sliderInput(&quot;X3.HBA&quot;, &quot;3-HBA&quot;, min = 0, max = 2000, value = 7.92)),
                     column(4, sliderInput(&quot;Caffeic.acid&quot;, &quot;Caffeic acid&quot;, min = 0, max = 300, value = 0))),
            
            fluidRow(column(4, sliderInput(&quot;X4.HBA&quot;, &quot;4-HBA&quot;, min = 0, max = 150, value = 40.17)),
                     column(4, sliderInput(&quot;p.Coumaric.acid&quot;, &quot;Coumaric acid&quot;, min = 0, max = 3000, value = 13.24)),
                     column(4, sliderInput(&quot;Ferulic.acid&quot;, &quot;Ferulic acid&quot;, min = 0, max = 1200, value = 17.91))),
            
            
            
            # strong(&quot;Assays&quot;, style = &quot;color:orange; font-size: 120%;&quot;),
            
            fluidRow(column(4, sliderInput(&quot;TPP.test&quot;, &quot;TPP test&quot;, min = 0, max = 15, value = 1.06)),
                     column(4, sliderInput(&quot;Antioxidant.test&quot;, &quot;Folin&#39;s test&quot;, min = 0, max = 15, value = 3.3)),
                     column(4, sliderInput(&quot;FRAP.test&quot;, &quot;FRAP test&quot;, min = 0, max = 10, value = 0.37))),
            
            
            # strong(&quot;Model names are abbreviated as acronyms:&quot;), br(), 
            span(strong(&quot;LDA&quot;), &quot;, Linear Discriminant Analysis&quot;), br(),br(),
            span(strong(&quot;LR&quot;), &quot;, Logistic (softmax) regression, lasso-regularized&quot;), br(),br(),
            span(strong(&quot;NB&quot;), &quot;, Naive Bayes&quot;), br(),br(),
            span(strong(&quot;RF&quot;), &quot;Random Forest&quot;), br(),br(),
            span(strong(&quot;SVM&quot;), &quot;, Support Vector Machine&quot;), br(),br()
            
        ),
        
        # Show a plot of the generated distribution
        mainPanel(
            plotOutput(&quot;plt.singleSampleFitted&quot;, height = 500)
        )
    )
)

# Define server logic required to draw a histogram
server &lt;- function(input, output) {
    
    # SINGLE SAMPLE PREDICTION
    
    output$plt.singleSampleFitted = renderPlot({
        
        # read user input data \
        newSample = data.frame(
            # Organic acids
            Citric.acid = input$Citric.acid, Malic.acid = input$Malic.acid, Ascorbic.acid = input$Ascorbic.acid,
            
            # Saccharides
            Sucrose = input$Sucrose, glucose.fructose = input$glucose.fructose,
            
            # Fenolic acids
            X3.4.di.HBA = input$X3.4.di.HBA, X3.HBA = input$X3.HBA, Caffeic.acid = input$Caffeic.acid,
            X4.HBA = input$X4.HBA, p.Coumaric.acid = input$p.Coumaric.acid, Ferulic.acid = input$Ferulic.acid,
            
            # Assays
            TPP.test = input$TPP.test, Antioxidant.test = input$Antioxidant.test, FRAP.test = input$FRAP.test
        )
        
        newSample.scaled = newSample %&gt;% scale(center = vector.mean, scale = vector.std) %&gt;% as_tibble()
        
        
        # ALL model results 
        
        # LDA
        fitted.label.svm = predict(mdl.svm, newdata = newSample.scaled)
        # RF
        fitted.label.rf = predict(mdl.rf, newSample.scaled, type = &quot;response&quot;)
        fitted.prob.rf =  predict(mdl.rf, newSample.scaled, type = &quot;prob&quot;)
        # NB
        fitted.label.nb  = predict(mdl.nb, newdata = newSample.scaled)
        fitted.prob.nb = predict(mdl.nb, newdata = newSample.scaled, type = &quot;raw&quot;)
        # LR
        fitted.label.lr = predict(mdl.lr, newx = newSample.scaled %&gt;% as.matrix(), type = &quot;class&quot;)[[1]] 
        fitted.prob.lr = predict(mdl.lr, newx = newSample.scaled %&gt;% as.matrix(),
                                 lambda = 0.07898059, type = &quot;response&quot;)[, , 1] 
        
        # Summarize predicted label
        d.fitted.label = data.frame(LDA =fitted.label.lda, NB = fitted.label.nb, LR = fitted.label.lr, 
                                    RF = fitted.label.rf, SVM = fitted.label.svm) %&gt;%
            gather(key = model, value = fitted.Model)
        
        theme.pureText = theme_bw() + theme(axis.ticks = element_blank(),
                                            axis.title.y = element_text(colour = &quot;white&quot;),
                                            axis.text.y =  element_text(colour = &quot;white&quot;),
                                            panel.grid = element_blank(),
                                            panel.border = element_blank(),
                                            axis.text.x = element_blank(),
                                            axis.title.x = element_blank())
        
        # Fitted type resutls
        plt.fitted.model =  d.fitted.label %&gt;%
            ggplot(aes(x = model, y = 1)) + 
            geom_label(aes(label = fitted.Model, fill = fitted.Model), 
                       size = 7, fontface = &quot;bold&quot;,
                       label.padding  = unit(.8, &quot;lines&quot;), label.size = unit(0, &quot;lines&quot;)) + 
            scale_fill_manual(values = color.types) +  theme.pureText + theme(legend.position = &quot;none&quot;)
        plt.fitted.model
        
        # Model names
        plt.modleNames = d.fitted.label %&gt;%
            ggplot(aes(x = model, y = 1)) + 
            geom_text(aes(label = model), size = 6, fontface = &quot;bold&quot;) + theme.pureText
        plt.modleNames
        
        # Combine model names and fitted resutls of a single new sample
        plt.labels = plot_grid(plt.modleNames, plt.fitted.model, nrow = 2)
        plt.labels
        
        
        
        # Summarize probability distribution
        func.tidyFittedProb = function(dataset, modelName){
            dataset %&gt;% as_tibble() %&gt;% 
                mutate(Sample = 1:nrow(dataset)) %&gt;% 
                gather(1:3, key = fitted.type, value = fitted.prob) %&gt;%
                arrange(Sample) %&gt;% 
                mutate(model = modelName)
        }
        
        
        fitted.prob.lda = fitted.prob.lda %&gt;% func.tidyFittedProb(modelName = &quot;LDA&quot;)
        fitted.prob.nb = fitted.prob.nb %&gt;% func.tidyFittedProb(modelName = &quot;NB&quot;)
        fitted.prob.rf = fitted.prob.rf %&gt;% func.tidyFittedProb(modelName = &quot;RF&quot;)
        fitted.prob.LR = tibble(Sample = 1, fitted.type = names(fitted.prob.lr), 
                                fitted.prob = fitted.prob.lr, model = &quot;LR&quot;)
        
        
        fitted.prob =  rbind(fitted.prob.lda, fitted.prob.nb) %&gt;% rbind(fitted.prob.rf) %&gt;%
            rbind(fitted.prob.LR)
        
        plt.prob = fitted.prob %&gt;%
            ggplot(aes(x = 1, y = fitted.prob, fill = fitted.type)) +
            geom_bar(stat = &quot;identity&quot;, position = &quot;stack&quot;) +
            facet_wrap(~model, nrow = 1) +
            
            scale_fill_manual(values = color.types) +
            
            geom_text(aes(label = round(fitted.prob, 2)), position = position_stack(.5), 
                      color = &quot;black&quot;, fontface = &quot;bold&quot;, size = 5) +
            theme(axis.text.x = element_blank(),
                  axis.title.x = element_blank(),
                  axis.ticks.x = element_blank(),
                  
                  axis.text.y = element_text(size = 14, color = &quot;black&quot;),
                  axis.title.y = element_text(size = 15),
                  
                  panel.border = element_blank(),
                  panel.grid = element_blank(),
                  legend.title = element_blank(),
                  strip.text = element_text(size = 17),
                  
                  legend.position = &quot;bottom&quot;,
                  legend.text = element_text(face = &quot;bold&quot;, size = 14))  +
            labs(y = &quot;Probability\n&quot;) +
            scale_y_continuous(breaks = seq(0, 1, by = .2))
        
        plt.prob  
        
        # White space
        whiteSpace = ggplot() + theme_void()
        
        # Combine all plots
        plt.singleSampleFitted = 
            plot_grid(plt.labels, whiteSpace, plt.prob, nrow = 3, rel_heights = c(2, .6, 5),
                      labels = c(&quot;A&quot;, &quot;&quot;, &quot;B&quot;), label_size = 23, label_colour = &quot;firebrick&quot;)
        return(plt.singleSampleFitted)
    })
    
}

# Run the application 
shinyApp(ui = ui, server = server)</code></pre>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
